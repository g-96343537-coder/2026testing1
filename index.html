<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¸Šå­¦äº† - åœ¨çº¿æœ—è¯»ä½œä¸š</title>
  <style>
    :root{
      --bg:#fff8ff;
      --card:#fff;
      --accent:#ff9fc4;
      --accent-hover:#ff7eb0;
      --accent2:#ffd6a5;
      --text:#333;
      --muted:#7a6b7a;
      --shadow: 0 8px 24px rgba(122,107,122,0.12);
    }
    html,body{height:100%;margin:0;font-family:"PingFang SC","Microsoft YaHei","Noto Sans CJK SC",sans-serif;background:url('https://wallpaperaccess.com/full/1164977.jpg') center/cover no-repeat fixed;color:var(--text)}
    
    /* é€šç”¨å¸ƒå±€ */
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing: border-box;}
    
    /* å¡ç‰‡å®¹å™¨ */
    .card{
      width:800px;
      max-width:100%;
      background:var(--card);
      border-radius:24px;
      padding:40px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction: column;
      align-items:center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    /* æ ‡é¢˜åŒºåŸŸ */
    .header-area{text-align:center; margin-bottom: 20px;}
    .avatar{
      width:80px;height:80px;border-radius:20px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      display:inline-flex;align-items:center;justify-content:center;
      font-weight:700;color:#fff;font-size:36px;
      box-shadow:0 6px 18px rgba(255,159,196,0.3);
      margin-bottom: 15px;
    }
    h1{margin:0;font-size:24px;color:#4a3b4a;}
    p.subtitle{margin:8px 0 0;color:var(--muted);font-size:14px;}

    /* é¡µé¢åˆ‡æ¢åŠ¨ç”» */
    .view-section { display: none; width: 100%; animation: fadeIn 0.5s ease; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

    /* --- ç™»å½•é¡µæ ·å¼ --- */
    .form-group { margin-bottom: 20px; text-align: left; width: 100%; max-width: 320px; margin-left: auto; margin-right: auto; }
    label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--muted); }
    select, input { 
      width: 100%; padding: 12px; border: 2px solid #ffe4ed; border-radius: 12px; 
      font-size: 16px; outline: none; box-sizing: border-box; transition: border-color 0.3s;
    }
    select:focus, input:focus { border-color: var(--accent); }
    
    .google-btn {
      background: #fff; border: 1px solid #ddd; color: #555;
      display: flex; align-items: center; justify-content: center; gap: 10px;
      width: 100%; max-width: 320px; padding: 10px; border-radius: 12px;
      cursor: pointer; font-weight: 600; margin: 10px auto;
      transition: background 0.2s;
    }
    .google-btn:hover { background: #f9f9f9; }
    .google-icon { width: 20px; height: 20px; }

    .btn-large {
      background: linear-gradient(90deg,var(--accent),#ffd6a5);
      color: #7a2e4a; border: none; padding: 14px 40px;
      font-size: 18px; font-weight: bold; border-radius: 50px;
      cursor: pointer; box-shadow: 0 6px 16px rgba(255,159,196,0.4);
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 20px; width: 100%; max-width: 320px;
    }
    .btn-large:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255,159,196,0.6); }
    .btn-large:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    /* --- æœ—è¯»é¡µæ ·å¼ --- */
    .sentence-box{
      background:linear-gradient(180deg,#ffffff,#fffaf6);
      border-radius:16px; padding:30px 20px;
      display:flex; align-items:center; justify-content:center;
      min-height:180px; width: 100%; margin: 20px 0;
      border: 1px solid #fff0f5;
    }
    .sentence{font-size:36px;line-height:1.6;text-align:center;letter-spacing:2px; color: #444;}
    .sentence .ch{transition: color 150ms ease, transform 150ms ease; display: inline-block;}
    
    .controls{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:10px; flex-wrap: wrap;}
    .ctrl-btn{
      padding:10px 20px; border-radius:12px; border:none; cursor:pointer; font-weight:700; font-size: 15px;
      box-shadow:0 4px 12px rgba(0,0,0,0.05); transition: background 0.2s;
    }
    .btn-primary{background:var(--accent);color:#fff;}
    .btn-primary:hover{background:var(--accent-hover);}
    .btn-ghost{background:#fff; border:2px solid #ffe4ed; color:var(--accent);}
    .btn-ghost:hover{background:#fff0f5;}
    
    .progress-info { margin-top: 15px; font-size: 13px; color: var(--muted); }

    /* --- æ­å–œé¡µæ ·å¼ --- */
    .success-icon { font-size: 60px; margin-bottom: 20px; animation: pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }
    .congrats-text { font-size: 22px; color: var(--text); margin-bottom: 10px; }
    .sub-congrats { color: var(--muted); margin-bottom: 30px; }

    /* å“åº”å¼ */
    @media (max-width:600px){
      .card{padding:24px;}
      .sentence{font-size:26px;}
      .btn-large{width: 100%;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    
    <div id="loginView" class="card view-section active">
      <div class="header-area">
        <div class="avatar">ğŸ“–</div>
        <h1>ä¸Šå­¦äº† - è¯¾æ–‡æœ—è¯»</h1>
        <p class="subtitle">è¯·å…ˆé€‰æ‹©ç­çº§å¹¶ç™»å½•</p>
      </div>

      <div class="form-group">
        <label>é€‰æ‹©ç­çº§ (Class)</label>
        <select id="classSelect">
          <option value="" disabled selected>è¯·ç‚¹å‡»é€‰æ‹©...</option>
          <option value="1M">1M</option>
          <option value="1K">1K</option>
          <option value="1B">1B</option>
          <option value="1H">1H</option>
          <option value="1J">1J</option>
        </select>
      </div>

      <button class="google-btn" id="googleLoginBtn">
        <svg class="google-icon" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
        <span>ä½¿ç”¨ Google è´¦å·ç™»å½•</span>
      </button>
      <div id="loginMsg" style="color:#34a853; font-size:13px; margin-top:5px; display:none;">âœ… å·²è¿æ¥ Google è´¦å·</div>

      <button id="startAppBtn" class="btn-large" disabled>å¼€å§‹åšåŠŸè¯¾</button>
      
      <p style="font-size:12px; color:#aaa; margin-top:30px;">
        Â© åæ–‡è¯¾å®¤ Â· 
        <a href="https://script.google.com/macros/s/AKfycbyahyd-8x_6gElJBoFRRUt-Yj20BGOVdaGCDj_FU-v-1y_8eXzhEmugOXj4xOIGPX-Z/exec" target="_blank" style="color:#aaa; text-decoration:none;">åå°ç®¡ç†é“¾æ¥</a>
      </p>
    </div>

    <div id="readingView" class="card view-section">
      <div class="cute-head" style="display:flex;gap:15px;align-items:center;width:100%;margin-bottom:10px;">
        <div class="avatar" style="width:60px;height:60px;font-size:28px;margin:0;">è¯»</div>
        <div style="text-align:left;">
          <h1 style="font-size:20px;">æ­£åœ¨æœ—è¯»</h1>
          <p class="subtitle" id="studentInfoDisplay">å­¦ç”Ÿä¿¡æ¯</p>
        </div>
      </div>

      <div class="sentence-box" id="sentenceBox">
        <div class="sentence" id="sentenceText">åŠ è½½ä¸­...</div>
      </div>

      <div class="controls">
        <button id="prevBtn" class="ctrl-btn btn-ghost">â¬… ä¸Šä¸€å¥</button>
        <button id="playBtn" class="ctrl-btn btn-primary" style="padding:10px 30px; font-size:18px;">ğŸ”Š æœ—è¯»</button>
        <button id="nextBtn" class="ctrl-btn btn-ghost">ä¸‹ä¸€å¥ â¡</button>
      </div>
      
      <div class="controls" style="margin-top:15px;">
         <button id="autoBtn" class="ctrl-btn btn-ghost" style="font-size:13px; padding:8px 12px;">è‡ªåŠ¨æ’­æ”¾ï¼šå…³</button>
      </div>

      <div class="progress-info" id="footerInfo">è¿›åº¦ 1 / 4</div>
    </div>

    <div id="successView" class="card view-section" style="text-align:center;">
      <div class="success-icon">ğŸ‰</div>
      <h1 class="congrats-text">æ­å–œä½ ï¼</h1>
      <p class="sub-congrats">ä½ å·²ç»å®Œæˆäº†ä»Šå¤©çš„æœ—è¯»åŠŸè¯¾ã€‚<br>è€å¸ˆä¸ºä½ ç‚¹èµï¼ğŸ‘</p>
      
      <div style="background:#f0fff4; color:#2e7d32; padding:15px; border-radius:12px; margin-bottom:20px; font-size:14px;">
        âœ… å­¦ä¹ è®°å½•å·²ç”Ÿæˆ<br>
        <span style="font-size:12px; opacity:0.8;">(æ•°æ®å°†åŒæ­¥è‡³ Google åå°)</span>
      </div>

      <button onclick="location.reload()" class="btn-large">å†è¯»ä¸€æ¬¡</button>
    </div>

  </div>

  <script>
    // --- é…ç½®æ•°æ® ---
    // ä½ çš„ Google Apps Script URL
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyahyd-8x_6gElJBoFRRUt-Yj20BGOVdaGCDj_FU-v-1y_8eXzhEmugOXj4xOIGPX-Z/exec";
    
    const sentences = [
      "ä¸Šå­¦äº†ï¼Œä¸Šå­¦äº†ã€‚",
      "èŠ±å„¿è·Ÿæˆ‘æ‹›æ‹›æ‰‹ï¼Œ",
      "å¤ªé˜³è·Ÿæˆ‘ä¸€èµ·èµ°ï¼Œ",
      "ä¸€èµ·èµ°åˆ°æ ¡é—¨å£ã€‚"
    ];

    // --- çŠ¶æ€å˜é‡ ---
    let currentClass = "";
    let isLogged = false;
    let index = 0;
    let auto = false;
    let autoTimer = null;

    // --- ç•Œé¢å…ƒç´ å¼•ç”¨ ---
    const loginView = document.getElementById('loginView');
    const readingView = document.getElementById('readingView');
    const successView = document.getElementById('successView');
    
    const classSelect = document.getElementById('classSelect');
    const loginBtn = document.getElementById('googleLoginBtn');
    const startBtn = document.getElementById('startAppBtn');
    
    const sentenceText = document.getElementById('sentenceText');
    const footerInfo = document.getElementById('footerInfo');
    const studentInfoDisplay = document.getElementById('studentInfoDisplay');

    // --- 1. ç™»å½•ä¸åˆå§‹åŒ–é€»è¾‘ ---
    
    // æ£€æŸ¥æ˜¯å¦å…è®¸ç‚¹å‡»å¼€å§‹
    function checkStartEnable() {
      // åªè¦é€‰äº†ç­çº§ï¼Œä¸”ç‚¹å‡»äº†ç™»å½•æŒ‰é’®ï¼ˆæ¨¡æ‹Ÿï¼‰ï¼Œå°±å…è®¸å¼€å§‹
      if(classSelect.value && isLogged) {
        startBtn.disabled = false;
        startBtn.innerHTML = "å¼€å§‹åšåŠŸè¯¾ ğŸš€";
      } else {
        startBtn.disabled = true;
      }
    }

    classSelect.addEventListener('change', (e) => {
      currentClass = e.target.value;
      checkStartEnable();
    });

    loginBtn.addEventListener('click', () => {
      // æ¨¡æ‹Ÿç™»å½•è¿‡ç¨‹
      loginBtn.innerHTML = "âŒ› æ­£åœ¨è¿æ¥...";
      setTimeout(() => {
        isLogged = true;
        loginBtn.style.display = 'none'; // éšè—æŒ‰é’®
        document.getElementById('loginMsg').style.display = 'block'; // æ˜¾ç¤ºæˆåŠŸæ–‡å­—
        checkStartEnable();
      }, 800);
    });

    startBtn.addEventListener('click', () => {
      // åˆ‡æ¢ç•Œé¢
      loginView.classList.remove('active');
      setTimeout(() => {
         loginView.style.display = 'none';
         readingView.style.display = 'flex'; // å…ˆæ˜¾ç¤º flex
         // å¼ºåˆ¶é‡ç»˜
         void readingView.offsetWidth; 
         readingView.classList.add('active'); // å†åŠ åŠ¨ç”»
      }, 100);

      // åˆå§‹åŒ–é˜…è¯»å™¨
      studentInfoDisplay.textContent = `ç­çº§: ${currentClass} Â· æ­£åœ¨å­¦ä¹ `;
      loadSentence(0);
    });


    // --- 2. æœ—è¯»æ ¸å¿ƒé€»è¾‘ ---
    
    function loadSentence(i) {
      if(i < 0) i = 0;
      // å¦‚æœè¶…è¿‡æœ€åä¸€å¥ï¼Œè¿›å…¥å®Œæˆé¡µé¢
      if(i >= sentences.length) {
        finishHomework();
        return;
      }

      index = i;
      const txt = sentences[index];
      // ç”Ÿæˆå¸¦spançš„æ–‡å­—ç”¨äºé«˜äº®
      sentenceText.innerHTML = txt.split('').map((ch, idx) => `<span class="ch" data-i="${idx}">${ch}</span>`).join('');
      
      // ç®€å•çš„è¿›å…¥åŠ¨ç”»
      sentenceText.style.opacity = '0';
      sentenceText.style.transform = 'translateY(10px)';
      setTimeout(() => {
        sentenceText.style.transition = 'all 0.3s ease';
        sentenceText.style.opacity = '1';
        sentenceText.style.transform = 'translateY(0)';
      }, 50);

      footerInfo.textContent = `è¿›åº¦ ${index + 1} / ${sentences.length}`;
    }

    function playCurrent() {
      if(!('speechSynthesis' in window)) return alert('è®¾å¤‡ä¸æ”¯æŒæœ—è¯»');
      window.speechSynthesis.cancel();
      clearHighlights();
      
      const msg = new SpeechSynthesisUtterance(sentences[index]);
      msg.lang = 'zh-CN';
      msg.rate = 0.9; // ç¨å¾®æ…¢ä¸€ç‚¹é€‚åˆä¸€å¹´çº§
      
      msg.onboundary = (e) => {
        if(e.name === 'word' || typeof e.charIndex === 'number') {
           highlight(e.charIndex);
        }
      };
      
      msg.onend = () => {
        setTimeout(clearHighlights, 1000);
        if(auto) {
          // è‡ªåŠ¨æ¨¡å¼ä¸‹ï¼Œè¯»å®Œä¸€å¥ç­‰1.5ç§’è‡ªåŠ¨ä¸‹ä¸€å¥
          autoTimer = setTimeout(() => next(), 1500);
        }
      };

      window.speechSynthesis.speak(msg);
    }

    function highlight(charIdx) {
      // æ¸…é™¤æ—§çš„é«˜äº®
      clearHighlights();
      // å°è¯•æ‰¾åˆ°å¯¹åº”å­—ç¬¦
      const span = document.querySelector(`.ch[data-i="${charIdx}"]`);
      if(span) {
        span.style.color = '#ff4fa3';
        span.style.transform = 'scale(1.2)';
      } else {
        // å®¹é”™ï¼šå¦‚æœæ‰¾ä¸åˆ°ç²¾ç¡®ç´¢å¼•ï¼Œé«˜äº®ç¬¬ä¸€ä¸ªæœªé«˜äº®çš„ï¼ˆç®€å•å¤„ç†ï¼‰
        const all = document.querySelectorAll('.ch');
        for(let s of all) {
            if(!s.style.color) { 
                s.style.color = '#ff4fa3'; 
                s.style.transform = 'scale(1.2)';
                break; 
            }
        }
      }
    }

    function clearHighlights() {
      document.querySelectorAll('.ch').forEach(el => {
        el.style.color = '';
        el.style.transform = '';
      });
    }

    function next() {
      loadSentence(index + 1);
      // å¦‚æœæ²¡æœ‰ç»“æŸï¼Œæ‰æœ—è¯»
      if(index < sentences.length && index !== 0) { // è¿™é‡Œçš„indexå…¶å®å·²ç»è¢« loadSentence æ›´æ–°äº†ï¼Œæˆ–è€…åœ¨ finish é‡Œè¢«æ‹¦æˆª
         if(auto) playCurrent();
      }
    }

    function prev() {
      loadSentence(index - 1);
    }

    // --- 3. å®Œæˆä¸æ•°æ®æäº¤é€»è¾‘ ---

    function finishHomework() {
      // åœæ­¢è‡ªåŠ¨æ’­æ”¾
      auto = false;
      clearTimeout(autoTimer);
      window.speechSynthesis.cancel();

      // å‘é€æ•°æ®åˆ°åå° (ä½¿ç”¨ beacon æˆ– img GET æ–¹å¼ç»•è¿‡ç®€å•è·¨åŸŸï¼Œæˆ–è€… fetch no-cors)
      // æ³¨æ„ï¼šä¸ºäº†è®©è¿™ä¸ªç”Ÿæ•ˆï¼Œä½ çš„ GAS è„šæœ¬å¿…é¡»æœ‰ doGet() å‡½æ•°å¤„ç†å‚æ•°
      submitDataToGAS();

      // åˆ‡æ¢åˆ°æˆåŠŸç•Œé¢
      readingView.classList.remove('active');
      readingView.style.display = 'none';
      
      successView.style.display = 'block';
      void successView.offsetWidth;
      successView.classList.add('active');
    }

    function submitDataToGAS() {
      // æ„å»ºæäº¤çš„æ•°æ®
      const timestamp = new Date().toLocaleString();
      // ç”±äºæµè§ˆå™¨çš„CORSç­–ç•¥ï¼Œç›´æ¥POSTé€šå¸¸ä¼šè¢«Googleæ‹’ç»ã€‚
      // è¿™é‡Œä½¿ç”¨ 'no-cors' æ¨¡å¼å‘é€ï¼Œæ„å‘³ç€æˆ‘ä»¬å¯ä»¥å‘é€è¯·æ±‚ï¼Œä½†æ”¶ä¸åˆ°â€œæˆåŠŸâ€çš„å›åº”ã€‚
      // æˆ–è€…ä½¿ç”¨ GET è¯·æ±‚å¸¦å‚æ•°ã€‚è¿™é‡Œæ¼”ç¤º GET è¯·æ±‚æ–¹å¼ï¼ˆé€šå¸¸æ›´ç¨³å®šç”¨äºç®€å•æ‰“å¡ï¼‰ã€‚
      
      const payload = {
        action: 'homework_complete',
        class: currentClass,
        lesson: 'ä¸Šå­¦äº†',
        time: timestamp
      };
      
      // å°†å‚æ•°æ‹¼æ¥åˆ° URL
      const params = new URLSearchParams(payload).toString();
      const finalUrl = `${GAS_URL}?${params}`;

      // ä½¿ç”¨ fetch å‘é€
      fetch(finalUrl, {
        method: 'GET',
        mode: 'no-cors', // é‡è¦ï¼šå…è®¸è·¨åŸŸå‘é€ï¼Œä½†ä¸è¯»å–è¿”å›å€¼
      }).then(() => {
        console.log("æ•°æ®å·²å°è¯•å‘é€");
      }).catch(err => {
        console.error("å‘é€å¤±è´¥", err);
      });
    }

    // --- äº‹ä»¶ç»‘å®š ---
    document.getElementById('playBtn').onclick = playCurrent;
    document.getElementById('nextBtn').onclick = next;
    document.getElementById('prevBtn').onclick = prev;
    
    document.getElementById('autoBtn').onclick = function() {
      auto = !auto;
      this.textContent = auto ? "è‡ªåŠ¨æ’­æ”¾ï¼šå¼€" : "è‡ªåŠ¨æ’­æ”¾ï¼šå…³";
      this.style.background = auto ? "#fff0f5" : "#fff";
      if(auto) playCurrent();
      else { clearTimeout(autoTimer); window.speechSynthesis.cancel(); }
    };

    // é”®ç›˜æ”¯æŒ
    window.addEventListener('keydown', (e) => {
      // åªæœ‰åœ¨æœ—è¯»ç•Œé¢æ‰å“åº”é”®ç›˜
      if(readingView.style.display !== 'none' && !successView.classList.contains('active')) {
        if(e.code === 'Space') { e.preventDefault(); playCurrent(); }
        if(e.code === 'ArrowRight') next();
        if(e.code === 'ArrowLeft') prev();
      }
    });

  </script>
</body>
</html>
